#!/bin/bash
# this script should be idempotent
set -euo pipefail
IFS=$'\n\t'

# find latest 1password backup
ONEPASS=$(cd "$HOME"; find "Library/Application Support/1Password 4/Backups/" -type f | tail -n 1)

function cleanup {
    rm -f "$HOME/divvy.txt"
}
trap cleanup EXIT

# backup insane divvy config
open "divvy://export" && pbpaste > "$HOME/divvy.txt"

# check if we have uncommitted changes which would be lost!
if ! git --git-dir="$HOME/.local/share/dotfiles/" --work-tree="$HOME" \
        diff-index --quiet HEAD --; then
    echo >&2 "Uncommitted changes, these won't be backed up!"
fi

# tar everything sensitive
tar czf "$HOME/backup-$(date +%Y-%m-%d).tar.gz" \
    -C "$HOME" \
    ".ssh/" ".aws/credentials" ".pypirc" "divvy.txt" \
    "$ONEPASS" \
    "Library/Application Support/Sublime Text 3/Local/License.sublime_license" \
    ".local/share/fish/fish_history" \
    -C "$HOME/.local/share/bin/" \
    "dot-bootstrap"
